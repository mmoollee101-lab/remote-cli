name: Build & Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --production

      - name: Build launcher exe
        run: |
          mkdir dist -ErrorAction SilentlyContinue
          & "C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe" /nologo /target:winexe /win32icon:app.ico /out:"dist\Claude Telegram Bot.exe" launcher.cs
        shell: pwsh

      - name: Create release package
        run: |
          $files = @(
            'bot.js',
            'package.json',
            'package-lock.json',
            '.env.example',
            'launcher.cs',
            'app.ico',
            'setup.bat',
            'README.md'
          )

          $dest = 'release\claude-telegram-bot'
          mkdir $dest -Force | Out-Null

          # Copy root files
          foreach ($f in $files) {
            if (Test-Path $f) { Copy-Item $f $dest }
          }

          # Copy node_modules
          Copy-Item -Recurse node_modules "$dest\node_modules"

          # Copy dist (exe)
          Copy-Item -Recurse dist "$dest\dist"

          # Create zip
          Compress-Archive -Path "$dest\*" -DestinationPath "claude-telegram-bot-${{ github.ref_name }}.zip"
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: claude-telegram-bot-*.zip
          body: |
            ## Installation

            ### Prerequisites
            - [Node.js 20+](https://nodejs.org)
            - [Claude Code CLI](https://www.npmjs.com/package/@anthropic-ai/claude-code) (`npm i -g @anthropic-ai/claude-code`)

            ### Quick Install
            1. Download and extract the zip
            2. Run `setup.bat` (installs dependencies + configures .env)
            3. Launch `dist\Claude Telegram Bot.exe`

            ### Manual Install
            1. Extract the zip
            2. Copy `.env.example` to `.env` and set your tokens
            3. `npm install` (node_modules included in zip, can skip)
            4. Run `dist\Claude Telegram Bot.exe` or `node bot.js`
          generate_release_notes: true
